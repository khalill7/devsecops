pipeline {
    agent any

    triggers {
        githubPush()
    }

    stages {

        stage('R√©cup√©ration du code Git') {
            steps {
                git branch: 'main',
                    changelog: false,
                    credentialsId: 'jenkins-github',
                    url: 'https://github.com/khalill7/devsecops.git'
            }
        }

        stage('MAVEN Build') {
            steps {
                sh 'mvn clean compile'
            }
        }
//semgrep scan
        stage('Semgrep Scan (SAST)') {
            steps {
                script {
                    sh '''
                        docker run --rm --privileged -v $WORKSPACE:/workspace semgrep/semgrep:latest bash -c "
                        semgrep --config=auto --jobs 1 --exclude '*/proc/*' \
                        --output=/workspace/semgrep-report.json /workspace/src
                        "
                    '''
                }
            }
        }

        stage('Gitleaks Scan (Secrets)') {
            steps {
                script {
                    def exitCode = sh(
                        script: '''
                            set +e
                            docker run --rm -v $WORKSPACE:/workspace zricethezav/gitleaks:latest detect \
                            --source=/workspace --report-path=/workspace/gitleaks-report.json \
                            --report-format=json
                        ''',
                        returnStatus: true
                    )

                    echo "Gitleaks exit code: ${exitCode}"

                    if (exitCode == 1) {
                        echo "‚ö†Ô∏è Gitleaks found secrets (non-blocking)."
                    } else if (exitCode != 0) {
                        error("Gitleaks failed with code ${exitCode}")
                    }
                }
            }
        }

        stage('SCA ‚Äì Dependency Analysis') {
            steps {
                script {
                    echo "‚ñ∂ Running Trivy..."

                    sh '''
                        docker run --rm \
                          -e TRIVY_DB_REPOSITORY=ghcr.io/aquasecurity/trivy-db \
                          -e TRIVY_TIMEOUT=10m \
                          -v /var/lib/jenkins/trivy-cache:/root/.cache/ \
                          -v $WORKSPACE:/workspace \
                          aquasec/trivy:latest fs \
                          --scanners vuln,misconfig,secret \
                          --exit-code 0 \
                          --format json \
                          --output /workspace/trivy-report.json /workspace
                    '''

                    sh '''
                        echo '{"dependency-check":"skipped"}' > dependency-check-report.json
                    '''

                    archiveArtifacts artifacts: 'dependency-check-report.json'
                }
            }
        }

        stage('Docker Image Build') {
            steps {
                script {
                    sh 'mvn clean package -DskipTests'

                    sh '''
                        if [ ! -f target/*.jar ]; then
                            echo "‚ùå No JAR found in target/. Run Maven build first."
                            exit 1
                        fi
                    '''

                    sh 'docker build -t khalill7/devsecops:latest .'
                }
            }
        }
//DAST zap
        stage('DAST ‚Äì OWASP ZAP Baseline') {
            steps {
                script {
                    def zapExit = sh(
                        returnStatus: true,
                        script: '''
                        docker run --rm \
                            --user root \
                            -v $WORKSPACE:/zap/wrk \
                            ghcr.io/zaproxy/zaproxy:stable \
                            zap-baseline.py \
                            -t http://192.168.50.4:8080 \
                            -r zap-baseline-report.html
                        '''
                    )

                    echo "ZAP Exit Code: ${zapExit}"

                    if (zapExit > 2) {
                        error "‚ùå ZAP failed critically (code ${zapExit})"
                    } else if (zapExit == 2 || zapExit == 1) {
                        echo "‚ö†Ô∏è ZAP warnings detected (non-blocking)."
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            environment {
                SONAR_HOST_URL = 'http://192.168.50.4:9000/'
                SONAR_AUTH_TOKEN = credentials('sonarqube')
            }
            steps {
                sh '''
                    mvn sonar:sonar \
                    -Dsonar.projectKey=khalill7 \
                    -Dsonar.host.url=$SONAR_HOST_URL \
                    -Dsonar.token=$SONAR_AUTH_TOKEN \
                    -Dsonar.qualitygate.wait=false
                '''
            }
        }
    }

    post {
        always {

            archiveArtifacts artifacts: '*.json, *.html', allowEmptyArchive: true

            publishHTML(target: [
                reportName: 'Security Reports',
                reportDir: '.',
                reportFiles: 'zap-baseline-report.html',
                keepAll: true
            ])
//email webhook
            echo "Pipeline completed with aggregated reports."

            emailext(
                subject: "üìä CI/CD Security Pipeline Report ‚Äì DevSecOps",
                body: """
                    <h3>Votre pipeline est termin√©</h3>
                    <p>Veuillez trouver tous les rapports de s√©curit√© ci-joints :</p>
                    <ul>
                        <li>Semgrep Report (SAST)</li>
                        <li>Gitleaks Report (Secrets)</li>
                        <li>Trivy FS Report</li>
                        <li>Dependency-Check Summary</li>
                        <li>ZAP Baseline Report</li>
                    </ul>
                    <p><b>Dashboard Jenkins :</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                """,
                to: "Guesmi.Khalil@esprit.tn",
                attachLog: false,
                attachmentsPattern: "*.json,*.html"
            )

            script {
                currentBuild.result = 'SUCCESS'
            }
        }
    }
}
